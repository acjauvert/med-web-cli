
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meds CLI v 1.5</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal/js/jquery.terminal.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.terminal/css/jquery.terminal.min.css"/>
    <style>
        body { margin: 0; height: 100vh; background-color: black; }
        .terminal { --size: 1.2; }
    </style>
</head>
<body>

<script>
const KEY_MAP = { 'meds': 'meds_logs', 'diabete': 'diabete_logs', 'gastro': 'gastro_logs' };
function getStorageKey(alias) { return KEY_MAP[alias] || null; }
const DIABETE_MAP = { 'rap': 'NOVORAPID', 'len': 'TRESIBA' };

function saveEntry(storageKey, entry) {
    const data = localStorage.getItem(storageKey);
    const logs = data ? JSON.parse(data) : [];
    logs.push(entry);
    localStorage.setItem(storageKey, JSON.stringify(logs));
}

$('body').terminal({
    // Utilisation de ...args pour accepter un nombre variable d'arguments (√©vite l'erreur Arity)
add: function(...args) {
        let entry = {
            id: Math.random().toString(36).substr(2, 5),
            date: new Date().toLocaleString('fr-FR'),
            cat: 'autre', nom: '', dose: ''
        };
        let secondaryLog = null;

        if (args[0] === '-e') {
            if (!DIABETE_MAP[args[1]] || !args[2]) {
                this.error('Usage: add -e <len|rap> <dose>');
                return;
            }
            entry.nom = DIABETE_MAP[args[1]];
            entry.dose = args[2] + " UI";
            entry.cat = 'endoc';
            secondaryLog = 'diabete_logs';
        } 
        else if (args[0] === '-g') {
            if (!args[1] || !args[2]) {
                this.error('Usage: add -g <nom> <dose>');
                return;
            }
            entry.nom = args[1];
            entry.dose = args[2];
            entry.cat = 'gastr';
            secondaryLog = 'gastro_logs';
        } 
        else {
            if (!args[0] || !args[1]) {
                this.error('Usage: add <nom> <dose>');
                return;
            }
            entry.nom = args[0];
            entry.dose = args[1];
        }

        saveEntry('meds_logs', entry);
        if (secondaryLog) saveEntry(secondaryLog, entry);
        
        this.echo(`[[b;green;]OK :] ${entry.nom} enregistr√©.`);
    },

list: function(type) {
        let key = 'meds_logs';
        if (type === '-e') key = 'diabete_logs';
        if (type === '-g') key = 'gastro_logs';
        
        const logs = JSON.parse(localStorage.getItem(key) || "[]");
        if (logs.length === 0) return this.echo('Historique vide.');
        
        logs.forEach(l => this.echo(`[[b;cyan;]${l.date}] [${l.cat}] ${l.nom} : ${l.dose}`));
    },



//~ R√©√©criture de la fonction del
    
del: async function(...args) {
    const params = {};
    for (let i = 0; i < args.length; i++) {
        // On force la conversion en string pour √©viter l'erreur .startsWith
        const arg = String(args[i]); 
        if (arg.startsWith('-')) {
            params[arg] = args[i + 1] !== undefined ? args[i + 1] : true;
        }
    }

    const storageKey = getStorageKey(params['-from']);
    if (!storageKey) {
        return this.error('Usage: del -from <meds|diabete|gastro> [options]');
    }

    let logs = JSON.parse(localStorage.getItem(storageKey) || "[]");
    const initialCount = logs.length;

    // --- LOGIQUE DE SUPPRESSION ---
    if (params['-all']) {
        const confirm = await this.read('Voulez-vous vraiment TOUT supprimer ? (y/n) : ');
        if (confirm.toLowerCase() === 'y') logs = [];
        else return this.echo('Annul√©.');
    } 
    else if (params['-id']) {
        logs = logs.filter(l => l.id !== String(params['-id']));
    } 
    else if (params['-date']) {
        logs = logs.filter(l => l.date !== String(params['-date']));
    } 
    else if (params['-last']) {
        const n = parseInt(params['-last']) || 1;
        logs.splice(-n);
    } 
    else if (params['-today'] || params['-day']) {
        const dateToMatch = params['-today'] 
            ? new Date().toLocaleDateString('fr-FR') 
            : String(params['-day']);
        logs = logs.filter(l => !l.date.startsWith(dateToMatch));
    }

    // Sauvegarde
    localStorage.setItem(storageKey, JSON.stringify(logs));
    const deleted = initialCount - logs.length;
    this.echo(`[[b;orange;]Suppression termin√©e :] ${deleted} entr√©e(s) supprim√©e(s).`);
},


//~ #########################
//~ Introduction d'une fonction svg pour exporter les trois tableaux:
//~ meds_logs, diabete_logs et gastro_logs

svg: function() {
    // R√©cup√©ration de toutes les donn√©es
    const data = {
        meds: JSON.parse(localStorage.getItem('meds_logs') || "[]"),
        diabete: JSON.parse(localStorage.getItem('diabete_logs') || "[]"),
        gastro: JSON.parse(localStorage.getItem('gastro_logs') || "[]")
    };

    // Conversion en cha√Æne JSON
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // Cr√©ation d'un lien invisible pour d√©clencher le t√©l√©chargement
    const link = document.createElement('a');
    link.href = url;
    link.download = `meds_svg_${new Date().toLocaleDateString('fr-FR').replace(/\//g, '-')}.json`;
    document.body.appendChild(link);
    link.click();
    
    // Nettoyage
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    this.echo("[[b;green;]Export r√©ussi :] Le fichier JSON a √©t√© g√©n√©r√©.");
},



    man: function() {
        this.echo("\n[[b;white;]MANUEL DES COMMANDES]");
        this.echo("- [[b;yellow;]add <nom> <dose>] : Prise standard");
        this.echo("- [[b;yellow;]add -e <len|rap> <dose>] : Insuline (Lente/Rapide)");
        this.echo("- [[b;yellow;]add -g <nom> <dose>] : Gastro-ent√©rologie");
        this.echo("- [[b;yellow;]list [-e|-g]] : Affiche le journal choisi\n");
        this.echo("- [[b;yellow;]del -from <journal> <option>] : Supprimer des entr√©es");
		this.echo("  Options: -id ID, -date \"...\", -last n, -today, -day DD/MM/AAAA, -all");
		this.echo("- [[b;yellow;]svg] : T√©l√©charge tous les logs en un fichier .json");

    },

    help: function() {
        this.echo('Commandes: [[b;white;]add], [[b;white;]list], [[b;white;]man], [[b;white;]clear]');
    }
}, {
    greetings: 'üíä TERMINAL M√âDICAMENTS v1.5\nTapez "man" pour les instructions.',
    prompt: 'user@meds> ',
    checkArity: false // Emp√™che l'erreur de nombre d'arguments
});
</script>
</body>
</html>

